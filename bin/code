#!/bin/bash
# Goldfix 开发环境启动脚本
# 功能：安装 pre-commit 钩子并启动 Claude Code

set -e  # 遇到错误时退出

PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
HOOKS_DIR="$PROJECT_ROOT/.git/hooks"
PRE_COMMIT_HOOK="$HOOKS_DIR/pre-commit"

echo "=== 启动 Goldfix 开发环境 ==="
echo "项目根目录: $PROJECT_ROOT"
echo ""

# 检查是否在 git 仓库中
if [ ! -d "$HOOKS_DIR" ]; then
    echo "错误: 当前目录不是 git 仓库或 .git/hooks 目录不存在"
    echo "请确保在 git 仓库根目录运行此脚本"
    exit 1
fi

# 安装 pre-commit 钩子（如果还没有安装）
echo "检查 pre-commit 钩子..."
if [ ! -f "$PRE_COMMIT_HOOK" ] || ! grep -q "bin/test" "$PRE_COMMIT_HOOK" 2>/dev/null; then
    echo "安装 pre-commit 钩子..."

    cat > "$PRE_COMMIT_HOOK" << 'EOF'
#!/bin/bash
# Goldfix pre-commit 钩子
# 在提交前自动运行测试

set -e

echo "=== 运行 pre-commit 钩子 ==="
echo "开始运行测试..."

# 运行测试脚本
if [ -f "./bin/test" ]; then
    ./bin/test
    if [ $? -ne 0 ]; then
        echo "错误: 测试失败，请修复后再提交"
        exit 1
    fi
else
    echo "警告: 找不到 bin/test 脚本"
    echo "跳过测试..."
fi

echo "=== pre-commit 钩子完成 ==="
EOF

    chmod +x "$PRE_COMMIT_HOOK"
    echo "pre-commit 钩子安装完成"
else
    echo "pre-commit 钩子已存在"
fi

echo ""
echo "=== 启动 Claude Code ==="
echo "正在启动 Claude Code 命令行工具..."

# 启动 Claude Code
# 注意：这里假设 claude 命令已经在 PATH 中
if command -v claude >/dev/null 2>&1; then
    echo "找到 Claude Code 命令行工具"
    echo ""
    echo "提示:"
    echo "1. 使用 'exit' 或 Ctrl+D 退出 Claude Code"
    echo "2. 提交代码时 pre-commit 钩子会自动运行测试"
    echo ""
    claude
else
    echo "错误: 找不到 claude 命令"
    echo "请确保 Claude Code 已正确安装并在 PATH 中"
    echo ""
    echo "可以尝试以下方法:"
    echo "1. 检查 Claude Code 是否已安装: https://claude.com/claude-code"
    echo "2. 将 Claude Code 添加到 PATH 环境变量"
    echo "3. 或者直接使用 Claude Code 的完整路径"
    exit 1
fi